name: Deploy to Staging

on:
  push:
    branches: 
      - staging
  pull_request:
    branches:
      - staging
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan-iac:
    name: Checkov Security Scan
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Run Checkov IaC Security Scan
        id: checkov-iac
        uses: bridgecrewio/checkov-action@v12.2867.0
        continue-on-error: true
        with:
          directory: .
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: true
          download_external_modules: true
          skip_check: CKV_AWS_51  # CRITICAL: Skip immutable tags check

      - name: Upload Checkov Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-results.sarif

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-Staging-Plan-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Initialize Terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_STAGING }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Plan
        run: terraform plan -out=tfplan.binary

      - name: Convert Plan to JSON for Security Analysis
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run Checkov on Terraform Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif
          output_file_path: console,checkov-plan-results.sarif
          soft_fail: false
          skip_check: CKV_AWS_51  # CRITICAL: Skip immutable tags check

      - name: Upload Checkov Plan Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-plan-results.sarif

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4.4.3
        with:
          name: tfplan-staging
          path: tfplan.binary
          retention-days: 5

  manual-approval:
    name: Staging Deployment Approval
    needs: terraform-plan
    runs-on: ubuntu-22.04
    if: github.event_name == 'push'
    environment: 
      name: staging
      url: https://github.com/${{ github.repository }}/actions
    steps:
      - name: Approval Gate
        run: |
          echo "âœ… Deployment to staging approved by ${{ github.actor }}"
          echo "ðŸ“… Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸ“ Commit SHA: ${{ github.sha }}"

  terraform-apply:
    name: Apply Infrastructure
    needs: terraform-plan
    runs-on: ubuntu-22.04
    if: github.event_name == 'push'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-Staging-Apply-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Initialize Terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_STAGING }}" \
            -backend-config="key=staging/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4.1.8
        with:
          name: tfplan-staging

      - name: Apply Infrastructure
        run: terraform apply -auto-approve tfplan.binary

  build-and-scan-image:
    name: Build & Scan Container Image
    needs: terraform-apply
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STAGING }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-Staging-Build-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Create ECR Repository if not exists
        env:
          ECR_REPOSITORY: demo-app-images
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: |
          aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} || \
          aws ecr create-repository \
            --repository-name ${ECR_REPOSITORY} \
            --image-scanning-configuration scanOnPush=true \
            --region ${AWS_REGION}

      - name: Build Container Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile docker/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:staging-latest

      - name: Run Trivy Security Scan (Strict)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Push Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:staging-latest

  notify-discord:
    name: Discord Notification
    runs-on: ubuntu-22.04
    if: always()
    needs: [security-scan-iac, terraform-plan, terraform-apply, build-and-scan-image]
    steps:
      - name: Send Status to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SEC_STATUS: ${{ needs.security-scan-iac.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          PLAN_STATUS: ${{ needs.terraform-plan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          APPLY_STATUS: ${{ needs.terraform-apply.result == 'success' && 'âœ… Applied' || 'âŒ Failed' }}
          BUILD_STATUS: ${{ needs.build-and-scan-image.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          OVERALL_STATUS: ${{ (needs.security-scan-iac.result == 'failure' || needs.terraform-plan.result == 'failure' || needs.terraform-apply.result == 'failure' || needs.build-and-scan-image.result == 'failure') && 'âŒ FAILED' || 'âœ… SUCCESS' }}
          OVERALL_COLOR: ${{ (needs.security-scan-iac.result == 'failure' || needs.terraform-plan.result == 'failure' || needs.terraform-apply.result == 'failure' || needs.build-and-scan-image.result == 'failure') && '15158332' || '3066993' }}
        run: |
          cat > payload.json <<JSON
          {
            "embeds": [{
              "title": "ðŸ”§ Staging Deployment",
              "description": "**Status:** ${OVERALL_STATUS}\n**Branch:** `${{ github.ref_name }}`\n**By:** ${{ github.actor }}",
              "color": ${OVERALL_COLOR},
              "fields": [
                {"name": "ðŸ”’ Security", "value": "${SEC_STATUS}", "inline": true},
                {"name": "ðŸ“‹ Plan", "value": "${PLAN_STATUS}", "inline": true},
                {"name": "ðŸš€ Apply", "value": "${APPLY_STATUS}", "inline": true},
                {"name": "ðŸ³ Build", "value": "${BUILD_STATUS}", "inline": true},
                {"name": "ðŸ”— Details", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          JSON

          curl -sS -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" --data @payload.json

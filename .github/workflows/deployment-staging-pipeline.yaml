name: Deploy to Production

on:
  push:
    branches: 
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

# Prevent concurrent Terraform runs against production
concurrency:
  group: terraform-production
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.7

jobs:
  # ==========================================================================
  # Security Scan (IaC Static Analysis)
  # ==========================================================================
  security-scan-iac:
    name: üîí Checkov Security Scan
    runs-on: ubuntu-22.04
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.action == 'deploy'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Run Checkov IaC Security Scan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          directory: .
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: false
          download_external_modules: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-results.sarif

  # ==========================================================================
  # PR Validation (Plan Preview Only - No Apply)
  # ==========================================================================
  validate-pr:
    name: üîç Validate PR Changes
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-Prod-PR-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_PROD }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Plan (Preview Only)
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      - name: Convert Plan to JSON
        if: success() || failure()
        run: |
          terraform plan -out=tfplan.binary -input=false
          terraform show -json tfplan.binary > tfplan.json

      - name: Run Checkov on Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        continue-on-error: true
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif,json
          output_file_path: console,checkov-plan-results.sarif,checkov-results.json
          soft_fail: false
          compact: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: checkov-results-pr
          path: checkov-results.json
          retention-days: 30

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = process.env.PLAN_OUTPUT;
            const truncated = output.length > 65000 ? 
              output.substring(0, 65000) + '\n\n...(truncated)' : 
              output;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üîç Terraform Plan Preview (Production)
            
            ‚ö†Ô∏è **This is a production deployment preview**
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            ### ‚úÖ Required Approvals
            This PR requires approval from authorized team members before deployment.
            
            **Security Checklist:**
            - [ ] Infrastructure changes reviewed
            - [ ] Security scan passed
            - [ ] No sensitive data exposed
            - [ ] Rollback plan confirmed
            
            *This is a preview only. No changes will be applied until merged to main branch and manually approved.*
            
            *Plan generated at: ${new Date().toUTCString()}*`
            })

  # ==========================================================================
  # Manual Approval Gate (Production)
  # ==========================================================================
  production-approval:
    name: üîê Production Approval
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      (github.event_name == 'workflow_dispatch')
    
    # Single environment for all operations
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Production Approval Checkpoint
        run: |
          echo "üîê Production operation approved by: ${{ github.actor }}"
          echo "üìÖ Approval time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "üìù Commit SHA: ${{ github.sha }}"
          echo "üîó Run ID: ${{ github.run_id }}"
          echo "‚öôÔ∏è  Action: ${{ github.event.inputs.action || 'deploy' }}"
          echo "‚ö†Ô∏è  WARNING: Operating on PRODUCTION environment"
          echo ""
          echo "Proceeding in 10 seconds..."
          sleep 10

  # ==========================================================================
  # Deploy to Production
  # CRITICAL: Plan and Apply run in the SAME job to prevent stale plans
  # ==========================================================================
  deploy-production:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-22.04
    needs: production-approval
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-Prod-Deploy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_PROD }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      # CRITICAL: Plan and Apply in the same job
      - name: Terraform Plan
        id: plan
        run: |
          echo "üìã Generating production execution plan..."
          terraform plan -out=tfplan.binary -input=false
          terraform show -no-color tfplan.binary

      - name: Convert Plan to JSON for Security Analysis
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run Checkov on Terraform Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif,json
          output_file_path: console,checkov-plan-results.sarif,checkov-results.json
          soft_fail: false
          compact: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Plan Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-plan-results.sarif

      - name: Upload Checkov JSON Results
        uses: actions/upload-artifact@v4.4.3
        with:
          name: checkov-results-production
          path: checkov-results.json
          retention-days: 90

      - name: Terraform Apply
        id: apply
        run: |
          echo "üöÄ Applying production infrastructure changes..."
          terraform apply -auto-approve tfplan.binary

      - name: Save Terraform Outputs
        id: tf-outputs
        if: success()
        run: |
          terraform output -json > terraform-outputs.json
          echo "ec2_public_ip=$(terraform output -raw ec2_public_ip 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT
          echo "‚úÖ Production deployment completed successfully!"
          terraform output

      - name: Upload Terraform Outputs
        if: success()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: terraform-outputs-production
          path: terraform-outputs.json
          retention-days: 90

      - name: Create Deployment Record
        if: success()
        run: |
          echo "## üéâ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Outputs:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Destroy Production Infrastructure
  # ==========================================================================
  destroy-production:
    name: üí• Destroy Production Infrastructure
    runs-on: ubuntu-22.04
    needs: production-approval
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-Prod-Destroy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_PROD }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Plan Destroy
        run: |
          echo "‚ö†Ô∏è  Planning infrastructure destruction..."
          terraform plan -destroy -out=tfdestroyplan
          terraform show -no-color tfdestroyplan

      - name: Final Confirmation
        run: |
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
          echo "About to DESTROY all production infrastructure"
          echo "This action is IRREVERSIBLE"
          echo "Waiting 30 seconds for cancellation..."
          sleep 30

      - name: Destroy Infrastructure
        run: |
          echo "üí• Destroying production infrastructure..."
          terraform apply -auto-approve tfdestroyplan

      - name: Log Destruction Event
        run: |
          echo "## üí• Production Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Build and Scan Container Image
  # ==========================================================================
  build-and-scan-image:
    name: üê≥ Build & Scan Container Image
    needs: deploy-production
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-Prod-Build-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Create ECR Repository if not exists
        env:
          ECR_REPOSITORY: demo-app-images
        run: |
          aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name ${ECR_REPOSITORY} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=KMS \
            --region ${{ env.AWS_REGION }}

      - name: Build Container Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile docker/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:prod-latest
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:v1.0.${{ github.run_number }}

      - name: Run Trivy Security Scan (Strict)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images:${{ github.sha }}
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM
        uses: actions/upload-artifact@v4.4.3
        with:
          name: sbom-production
          path: sbom.json
          retention-days: 365

      - name: Push Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:prod-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:v1.0.${{ github.run_number }}

  # ==========================================================================
  # Notifications
  # ==========================================================================
  notify-slack:
    name: üì¢ Slack Notification
    runs-on: ubuntu-22.04
    if: always() && (needs.deploy-production.result != 'skipped' || needs.destroy-production.result != 'skipped')
    needs: [security-scan-iac, deploy-production, destroy-production, build-and-scan-image]
    
    steps:
      - name: Send Production Status
        if: vars.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SEC_STATUS: ${{ needs.security-scan-iac.result == 'success' && '‚úÖ Passed' || needs.security-scan-iac.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
          DEPLOY_STATUS: ${{ needs.deploy-production.result == 'success' && '‚úÖ Deployed' || needs.deploy-production.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
          DESTROY_STATUS: ${{ needs.destroy-production.result == 'success' && 'üí• Destroyed' || needs.destroy-production.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
          BUILD_STATUS: ${{ needs.build-and-scan-image.result == 'success' && '‚úÖ Passed' || needs.build-and-scan-image.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}
          OVERALL: ${{ (needs.security-scan-iac.result == 'failure' || needs.deploy-production.result == 'failure' || needs.destroy-production.result == 'failure' || needs.build-and-scan-image.result == 'failure') && 'FAILED' || 'SUCCESS' }}
        run: |
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "üöÄ Production Pipeline '$OVERALL'",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Production Pipeline '$OVERALL'"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Environment:*\nProduction"},
                    {"type": "mrkdwn", "text": "*Branch:*\n`${{ github.ref_name }}`"},
                    {"type": "mrkdwn", "text": "*By:*\n${{ github.actor }}"},
                    {"type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`"}
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Security:*\n'$SEC_STATUS'"},
                    {"type": "mrkdwn", "text": "*Deploy:*\n'$DEPLOY_STATUS'"},
                    {"type": "mrkdwn", "text": "*Destroy:*\n'$DESTROY_STATUS'"},
                    {"type": "mrkdwn", "text": "*Build:*\n'$BUILD_STATUS'"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }'
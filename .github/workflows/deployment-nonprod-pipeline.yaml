name: Non-Prod Deployment

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

permissions:
  id-token: write
  contents: read
  pull-requests: write

# Prevent concurrent Terraform runs against the same environment
concurrency:
  group: terraform-nonprod
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.7

jobs:
  # ===========================================================================
  # PR-only validation job (plan without apply)
  # ===========================================================================
  validate-pr:
    name: Validate PR Changes
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-PR-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan (Preview Only)
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = process.env.PLAN_OUTPUT;
            const truncated = output.length > 65000 ? 
              output.substring(0, 65000) + '\n\n...(truncated)' : 
              output;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan (Non-Prod)
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            *This is a preview only. No changes will be applied until merged to develop branch.*
            
            *Plan generated at: ${new Date().toUTCString()}*`
            })

  # ============================================================================
  # Manual Approval Gate
  # ============================================================================
  approval-gate:
    name: ðŸ”’ Non-Prod Approval
    runs-on: ubuntu-22.04
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch')
    
    # Single environment for all operations (deploy/destroy)
    environment:
      name: nonprod
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Approval Checkpoint
        run: |
          echo "âœ… Non-Prod operation approved by: ${{ github.actor }}"
          echo "ðŸ“… Approval time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸ“ Commit SHA: ${{ github.sha }}"
          echo "ðŸ”— Run ID: ${{ github.run_id }}"
          echo "âš™ï¸  Action: ${{ github.event.inputs.action || 'deploy' }}"
          echo ""
          echo "âš ï¸  Proceeding with infrastructure changes..."

  # ============================================================================
  # Deploy Infrastructure
  # Plan and Apply in the SAME job to avoid stale plans
  # ============================================================================
  deploy-nonprod:
    name: ðŸš€ Deploy to Non-Prod
    runs-on: ubuntu-22.04
    needs: approval-gate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-Deploy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      # CRITICAL: Plan and Apply in the same job
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan.binary -input=false
          echo "ðŸ“‹ Generating execution plan..."
          terraform show -no-color tfplan.binary

      - name: Terraform Apply
        id: apply
        run: |
          echo "ðŸš€ Applying infrastructure changes..."
          terraform apply -auto-approve tfplan.binary

      - name: Save Terraform Outputs
        if: success()
        run: |
          terraform output -json > terraform-outputs.json
          echo "âœ… Deployment completed successfully!"
          terraform output

      - name: Upload Terraform Outputs
        if: success()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: terraform-outputs-nonprod
          path: terraform-outputs.json
          retention-days: 30

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Non-Prod Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Outputs:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Destroy Infrastructure (manual trigger with destroy option)
  # ============================================================================
  destroy-nonprod:
    name: ðŸ’¥ Destroy Non-Prod Infrastructure
    runs-on: ubuntu-22.04
    needs: approval-gate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-Destroy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Plan Destroy
        run: |
          echo "âš ï¸  Planning infrastructure destruction..."
          terraform plan -destroy -out=tfdestroyplan
          terraform show -no-color tfdestroyplan

      - name: Terraform Destroy
        run: |
          echo "ðŸ’¥ Destroying non-prod infrastructure..."
          terraform apply -auto-approve tfdestroyplan

      - name: Destruction Summary
        run: |
          echo "## ðŸ’¥ Non-Prod Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
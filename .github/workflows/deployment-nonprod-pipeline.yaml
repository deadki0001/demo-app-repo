name: Deploy to Non-Production

on:
  push:
    branches:
      - nonprod
  pull_request:
    branches:
      - nonprod
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write
  issues: write

concurrency:
  group: terraform-nonprod
  cancel-in-progress: false

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.7

jobs:
  # ========================================================================
  # Security Scan (IaC Static Analysis)
  # ========================================================================
  security-scan-iac:
    name: ðŸ”’ Checkov Security Scan
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Run Checkov IaC Security Scan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          directory: .
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: false
          download_external_modules: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-results.sarif

  # =========================================================================
  # PR Validation (Plan Preview Only - No Apply)
  # =========================================================================
  validate-pr:
    name: ðŸ” Validate PR Changes
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-PR-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Plan (Preview Only)
        id: plan
        run: |
          terraform plan -no-color -input=false
        continue-on-error: true

      - name: Convert Plan to JSON
        if: success() || failure()
        run: |
          terraform plan -out=tfplan.binary -input=false
          terraform show -json tfplan.binary > tfplan.json

      - name: Run Checkov on Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        continue-on-error: true
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif,json
          output_file_path: console,checkov-plan-results.sarif,checkov-results.json
          soft_fail: false
          compact: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Results
        uses: actions/upload-artifact@v4.4.3
        if: always()
        with:
          name: checkov-results-pr
          path: checkov-results.json
          retention-days: 30

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = process.env.PLAN_OUTPUT;
            const truncated = output.length > 65000 ? 
              output.substring(0, 65000) + '\n\n...(truncated)' : 
              output;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ” Terraform Plan Preview (Non-Production)
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            ### âœ… Security Checklist
            - [ ] Infrastructure changes reviewed
            - [ ] Security scan passed
            - [ ] No sensitive data exposed
            
            *This is a preview only. No changes will be applied until merged to nonprod branch.*
            
            *Plan generated at: ${new Date().toUTCString()}*`
            })

  # ==========================================================================
  # Manual Approval Gate (Non-Production)
  # ==========================================================================
  nonprod-approval:
    name: ðŸ” Non-Production Approval
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/nonprod') || 
      (github.event_name == 'workflow_dispatch')
    
    environment:
      name: nonprod-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
      - name: Non-Production Approval Checkpoint
        run: |
          echo "ðŸ” Non-production deployment approved by: ${{ github.actor }}"
          echo "ðŸ“… Approval time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸ“ Commit SHA: ${{ github.sha }}"
          echo "ðŸ”— Run ID: ${{ github.run_id }}"
          echo "âš™ï¸  Action: ${{ github.event.inputs.action || 'deploy' }}"
          echo ""
          echo "Proceeding with non-production deployment in 5 seconds..."
          sleep 5

  # ==========================================================================
  # Deploy to Non-Production
  # CRITICAL: Plan and Apply run in the SAME job to prevent stale plans
  # ==========================================================================
  deploy-nonprod:
    name: ðŸš€ Deploy to Non-Production
    runs-on: ubuntu-22.04
    needs: nonprod-approval
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/nonprod') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy')
    
    environment:
      name: nonprod
      url: https://nonprod.yourdomain.com
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-Deploy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Plan
        id: plan
        run: |
          echo "ðŸ“‹ Generating non-production execution plan..."
          terraform plan -out=tfplan.binary -input=false
          terraform show -no-color tfplan.binary

      - name: Convert Plan to JSON for Security Analysis
        run: terraform show -json tfplan.binary > tfplan.json

      - name: Run Checkov on Terraform Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif,json
          output_file_path: console,checkov-plan-results.sarif,checkov-results.json
          soft_fail: false
          compact: true
          skip_check: CKV_AWS_51

      - name: Upload Checkov Plan Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-plan-results.sarif

      - name: Upload Checkov JSON Results
        uses: actions/upload-artifact@v4.4.3
        with:
          name: checkov-results-nonprod
          path: checkov-results.json
          retention-days: 30

      - name: Terraform Apply
        id: apply
        run: |
          echo "ðŸš€ Applying non-production infrastructure changes..."
          terraform apply -auto-approve tfplan.binary

      - name: Save Terraform Outputs
        id: tf-outputs
        if: success()
        run: |
          # Create outputs file (will be empty if no outputs defined)
          terraform output -json > terraform-outputs.json || echo "{}" > terraform-outputs.json
          
          # Try to get specific outputs, use fallback if not available
          EC2_IP=$(terraform output -raw ec2_public_ip 2>/dev/null || echo 'not-available')
          echo "ec2_public_ip=${EC2_IP}" >> $GITHUB_OUTPUT
          
          echo "âœ… Non-production deployment completed successfully!"
          
          # Only display outputs if they exist
          if terraform output 2>/dev/null | grep -q .; then
            echo "ðŸ“Š Terraform Outputs:"
            terraform output
          else
            echo "â„¹ï¸  No Terraform outputs defined"
          fi

      - name: Upload Terraform Outputs
        if: success()
        uses: actions/upload-artifact@v4.4.3
        with:
          name: terraform-outputs-nonprod
          path: terraform-outputs.json
          retention-days: 30

      - name: Create Deployment Record
        if: success()
        run: |
          echo "## ðŸŽ‰ Non-Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only show outputs if they exist
          if terraform output 2>/dev/null | grep -q .; then
            echo "**Terraform Outputs:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            terraform output >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "**Terraform Outputs:** None defined" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # Build and Scan Container Image
  # ==========================================================================
  build-and-scan-image:
    name: ðŸ³ Build & Scan Container Image
    needs: deploy-nonprod
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-Build-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Create ECR Repository if not exists
        env:
          ECR_REPOSITORY: demo-app-images-nonprod
        run: |
          aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository \
            --repository-name ${ECR_REPOSITORY} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=KMS \
            --region ${{ env.AWS_REGION }}

      - name: Build Container Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images-nonprod
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile docker/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:nonprod-latest
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:v1.0.${{ github.run_number }}

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images-nonprod:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images-nonprod:${{ github.sha }}
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM
        uses: actions/upload-artifact@v4.4.3
        with:
          name: sbom-nonprod
          path: sbom.json
          retention-days: 90

      - name: Push Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images-nonprod
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:nonprod-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:v1.0.${{ github.run_number }}

  # ==========================================================================
  # Destroy Non-Production Infrastructure (Manual Only)
  # ==========================================================================
  destroy-nonprod:
    name: ðŸ’¥ Destroy Non-Production Infrastructure
    runs-on: ubuntu-22.04
    needs: nonprod-approval
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GHA-NonProd-Destroy-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Plan Destroy
        run: |
          echo "âš ï¸  Planning infrastructure destruction..."
          terraform plan -destroy -out=tfdestroyplan
          terraform show -no-color tfdestroyplan

      - name: Final Confirmation
        run: |
          echo "âš ï¸ WARNING: About to destroy non-production infrastructure"
          echo "This action is IRREVERSIBLE"
          echo "Waiting 15 seconds for cancellation..."
          sleep 15

      - name: Destroy Infrastructure
        run: |
          echo "ðŸ’¥ Destroying non-production infrastructure..."
          terraform apply -auto-approve tfdestroyplan

      - name: Log Destruction Event
        run: |
          echo "## ðŸ’¥ Non-Production Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Destroyed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Discord Notifications
  # ==========================================================================
  notify-discord:
    name: ðŸ“¢ Discord Notification
    runs-on: ubuntu-22.04
    if: always() && (needs.deploy-nonprod.result != 'skipped' || needs.destroy-nonprod.result != 'skipped')
    needs: [security-scan-iac, deploy-nonprod, destroy-nonprod, build-and-scan-image]
    
    steps:
      - name: Send Non-Production Status to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SEC_STATUS: ${{ needs.security-scan-iac.result == 'success' && 'âœ… Passed' || needs.security-scan-iac.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}
          DEPLOY_STATUS: ${{ needs.deploy-nonprod.result == 'success' && 'âœ… Deployed' || needs.deploy-nonprod.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}
          DESTROY_STATUS: ${{ needs.destroy-nonprod.result == 'success' && 'ðŸ’¥ Destroyed' || needs.destroy-nonprod.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}
          BUILD_STATUS: ${{ needs.build-and-scan-image.result == 'success' && 'âœ… Passed' || needs.build-and-scan-image.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}
          OVERALL_STATUS: ${{ (needs.security-scan-iac.result == 'failure' || needs.deploy-nonprod.result == 'failure' || needs.destroy-nonprod.result == 'failure' || needs.build-and-scan-image.result == 'failure') && 'âŒ FAILED' || 'âœ… SUCCESS' }}
          OVERALL_COLOR: ${{ (needs.security-scan-iac.result == 'failure' || needs.deploy-nonprod.result == 'failure' || needs.destroy-nonprod.result == 'failure' || needs.build-and-scan-image.result == 'failure') && '15158332' || '3066993' }}
        run: |
          cat > payload.json <<'EOF'
          {
            "embeds": [{
              "title": "ðŸ”§ Non-Production Deployment",
              "description": "**Status:** ${OVERALL_STATUS}\n**Branch:** `${{ github.ref_name }}`\n**By:** ${{ github.actor }}",
              "color": ${OVERALL_COLOR},
              "fields": [
                {"name": "ðŸ”’ Security", "value": "${SEC_STATUS}", "inline": true},
                {"name": "ðŸš€ Deploy", "value": "${DEPLOY_STATUS}", "inline": true},
                {"name": "ðŸ’¥ Destroy", "value": "${DESTROY_STATUS}", "inline": true},
                {"name": "ðŸ³ Build", "value": "${BUILD_STATUS}", "inline": true},
                {"name": "ðŸ”— Details", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          
          # Replace environment variables
          sed -i "s/\${OVERALL_STATUS}/$OVERALL_STATUS/g" payload.json
          sed -i "s/\${OVERALL_COLOR}/$OVERALL_COLOR/g" payload.json
          sed -i "s/\${SEC_STATUS}/$SEC_STATUS/g" payload.json
          sed -i "s/\${DEPLOY_STATUS}/$DEPLOY_STATUS/g" payload.json
          sed -i "s/\${DESTROY_STATUS}/$DESTROY_STATUS/g" payload.json
          sed -i "s/\${BUILD_STATUS}/$BUILD_STATUS/g" payload.json
          
          curl -sS -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            --data @payload.json
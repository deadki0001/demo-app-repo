name: Deploy to Non-Prod

on:
  push:
    branches: 
      - nonprod
  pull_request:
    branches:
      - nonprod

permissions:
  id-token: write      # Required for OIDC
  contents: read
  pull-requests: write
  security-events: write

jobs:
  security-scan-iac:
    name: Checkov Security Scan
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      # Checkov scans our Terraform files for security misconfigurations
      # This catches things like unencrypted storage, overly permissive security groups, etc.
      - name: Run Checkov IaC Security Scan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          directory: .
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: false  # Fail the build if critical issues found
          download_external_modules: true

      # Upload results to GitHub Security tab for tracking
      - name: Upload Checkov Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-results.sarif

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-22.04
    needs: security-scan-iac
    container:
      image: hashicorp/terraform:1.5.7
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      # OIDC authentication - no stored credentials!
      # GitHub generates a temporary token that AWS trusts
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-NonProd-Plan-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Initialize Terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Plan
        run: terraform plan -out=tfplan.binary

      # Convert plan to JSON so Checkov can analyze what we're about to deploy
      - name: Convert Plan to JSON for Security Analysis
        run: terraform show -json tfplan.binary > tfplan.json

      # Scan the actual plan output - this catches computed values and dynamic resources
      - name: Run Checkov on Terraform Plan
        uses: bridgecrewio/checkov-action@v12.2867.0
        with:
          file: tfplan.json
          framework: terraform_plan
          output_format: cli,sarif
          output_file_path: console,checkov-plan-results.sarif
          soft_fail: false

      - name: Upload Checkov Plan Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: checkov-plan-results.sarif

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4.4.3
        with:
          name: tfplan-nonprod
          path: tfplan.binary
          retention-days: 5

  terraform-apply:
    name: Apply Infrastructure
    needs: terraform-plan
    runs-on: ubuntu-22.04
    if: github.event_name == 'push'  # Only auto-deploy on push, not PRs
    container:
      image: hashicorp/terraform:1.5.7
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-NonProd-Apply-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Initialize Terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET_NONPROD }}" \
            -backend-config="key=nonprod/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ vars.TF_STATE_LOCK_TABLE }}"

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4.1.8
        with:
          name: tfplan-nonprod

      - name: Apply Infrastructure
        run: terraform apply -auto-approve tfplan.binary

      - name: Save Terraform Outputs
        id: tf-outputs
        run: |
          echo "eks_cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo 'not-created')" >> $GITHUB_OUTPUT

  build-and-scan-image:
    name: Build & Scan Container Image
    needs: terraform-apply
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1

      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_NONPROD }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GHA-NonProd-Build-${{ github.sha }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Build Container Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/Dockerfile docker/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:nonprod-latest

      # Trivy scans for vulnerabilities in our container image
      # NonProd environment: we scan but don't block on vulnerabilities (soft_fail)
      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/demo-app-images:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail build in nonprod

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3.26.13
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Push Image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: demo-app-images
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:nonprod-latest